name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Download dependencies
        run: go mod download

      - name: Build
        run: go build -v ./...

  integration-test-coverage:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Download dependencies
        run: go mod download

      - name: Run integration tests with coverage
        run: make integration-test-coverage

      - name: Generate coverage summary
        id: coverage
        run: |
          # Get total coverage percentage
          TOTAL=$(go tool cover -func=coverage-integration.out | grep total | awk '{print $3}')
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

          # Generate detailed coverage by package
          DETAILS=$(go tool cover -func=coverage-integration.out | grep -v "total:" | head -30)
          echo "details<<EOF" >> $GITHUB_OUTPUT
          echo "$DETAILS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Count covered vs total statements
          COVERED=$(go tool cover -func=coverage-integration.out | grep -v "total:" | awk '{sum += $3} END {print NR " functions analyzed"}')
          echo "summary=$COVERED" >> $GITHUB_OUTPUT

      - name: Post coverage comment
        uses: actions/github-script@v7
        with:
          script: |
            const total = '${{ steps.coverage.outputs.total }}';
            const details = `${{ steps.coverage.outputs.details }}`;

            // Determine emoji based on coverage
            let emoji = 'ðŸ”´';
            const coverageNum = parseFloat(total);
            if (coverageNum >= 80) emoji = 'ðŸŸ¢';
            else if (coverageNum >= 60) emoji = 'ðŸŸ¡';
            else if (coverageNum >= 40) emoji = 'ðŸŸ ';

            const body = `## ${emoji} Integration Test Coverage: **${total}**

            <details>
            <summary>ðŸ“Š Coverage by function (top 30)</summary>

            \`\`\`
            ${details}
            \`\`\`

            </details>

            ---
            *Coverage generated from \`make integration-test-coverage\`*
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Integration Test Coverage')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
